def buildResults = [:]
def buildState = [:]

pipeline {
  agent any
  environment {
    SERVICES = 'order-service,user-service'
    BUILD_STATE_FILE = '.build-state.json'
  }

  stages {
    stage('PrÃ©paration') {
      steps {
        script {
          try {
            step([
              $class: 'CopyArtifact',
              projectName: env.JOB_NAME,
              selector: lastSuccessful(),
              filter: env.BUILD_STATE_FILE,
              target: '.',
              flatten: true
            ])
            echo "âœ… Artefact rÃ©cupÃ©rÃ© avec succÃ¨s"
          } catch (Exception e) {
            echo "âš ï¸ Impossible de restaurer l'artefact : ${e.message}"
          }

          buildState = [
            branch: env.BRANCH_NAME,
            buildNumber: env.BUILD_NUMBER,
            buildUrl: env.BUILD_URL,
            timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ssZ"),
            services: [:],
            previousState: [:]
          ]

          // Chargement Ã©tat prÃ©cÃ©dent
          if (fileExists(env.BUILD_STATE_FILE)) {
            try {
              def content = readFile(env.BUILD_STATE_FILE).trim()
              if (content && !content.allWhitespace) {
                echo "Contenu prÃ©cÃ©dent:\n${content}"
                // SÃ©curitÃ© contre LazyMap
                def safeJson = groovy.json.JsonOutput.toJson(
                  new groovy.json.JsonSlurper().parseText(content)
                )
                buildState.previousState = new groovy.json.JsonSlurper().parseText(safeJson) as Map
                echo "âœ… Ã‰tat prÃ©cÃ©dent chargÃ©"
              } else {
                echo "âš ï¸ Fichier d'Ã©tat vide"
              }
            } catch (Exception e) {
              echo "âš ï¸ Erreur parsing JSON : ${e.getMessage()}"
            }
          } else {
            echo "â„¹ï¸ Aucun fichier d'Ã©tat trouvÃ©"
          }

        }
      }
    }
  }

  /*post {
    failure {
      echo "âŒ Pipeline orchestrateur Ã©chouÃ©."
    }

    always {
      archiveArtifacts artifacts: env.BUILD_STATE_FILE, fingerprint: true
      echo "ðŸ“ RÃ©sumÃ© des builds :"
      script {
        buildResults.each { service, result ->
          echo "ðŸ”Ž ${service} : ${result}"
        }

        def successCount = buildResults.count { k, v -> v == 'SUCCESS' }
        def failureCount = buildResults.count { k, v -> v == 'FAILURE' }
        def abortedCount = buildResults.count { k, v -> v == 'ABORTED' }

        echo "ðŸ“Š TOTAL: ${buildResults.size()}, SUCCÃˆS: ${successCount}, Ã‰CHECS: ${failureCount}, ABANDONNÃ‰S: ${abortedCount}"

        if (fileExists(env.BUILD_STATE_FILE)) {
          echo "ðŸ“‚ Contenu du fichier d'Ã©tat :"
          echo readFile(env.BUILD_STATE_FILE)
        }
      }
    }
  }
}
